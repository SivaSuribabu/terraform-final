**Youâ€™re thinking correctly about cost control (10-hour UAT), but if you recreate everything daily, youâ€™ll introduce:**

DNS propagation delays
Beanstalk environment stabilization time (10â€“20 mins)
Load balancer re-provisioning delays
Drift + pipeline instability
Developer friction

So the right approach is:

Keep network + identity static.
Make compute ephemeral.

1ï¸âƒ£ What MUST Be Static (Create Once)

These resources should never be destroyed daily.

Network Layer (Static Foundation)
VPC
Private subnets (min 2 AZs)
Public subnets (only if NAT needed)
NAT Gateway (if private instances need internet)
Route tables
Internet Gateway (if NAT used)

These are slow + expensive to recreate and cause route propagation delays.

Security & Identity (Static)
Security Groups
IAM Roles
Beanstalk service role
EC2 instance profile role
KMS keys (if used)
S3 artifact bucket (for Beanstalk versions)

Destroying these daily causes dependency chaos.
Internal DNS (Static)
Route53 Private Hosted Zone
UAT internal record (ALIAS â†’ ALB)

Example:

uat.internal.company.local
Donâ€™t recreate this daily â€” DNS caching will hurt you.

2ï¸âƒ£ What Should Be Ephemeral (10 Hours Only)

Only these should be created/destroyed daily:

Elastic Beanstalk Application
Elastic Beanstalk Environment
Auto Scaling Group
EC2 instances
Internal ALB (created by Beanstalk)
Target Groups

When you terminate the environment â†’ everything above goes.

3ï¸âƒ£ Target Architecture (Internal Only)

Here is the full internal-only flow:

                 Developers (VPN / Direct Connect)
                           |
                           |
                    Route53 Private Hosted Zone
                           |
                           |
                 Internal ALB (Scheme = internal)
                           |
                           |
                  Beanstalk Auto Scaling Group
                           |
                           |
                    EC2 in Private Subnets
                   


5ï¸âƒ£ Terraform Modular Structure (Enterprise Grade)

You need layered modules.

terraform/
â”‚
â”œâ”€â”€ modules/
â”‚   â”œâ”€â”€ vpc/
â”‚   â”œâ”€â”€ security-groups/
â”‚   â”œâ”€â”€ iam/
â”‚   â”œâ”€â”€ route53-private/
â”‚   â”œâ”€â”€ beanstalk-app/
â”‚   â”œâ”€â”€ beanstalk-env/
â”‚
â”œâ”€â”€ environments/
â”‚   â”œâ”€â”€ uat/
â”‚       â”œâ”€â”€ main.tf
â”‚       â”œâ”€â”€ variables.tf
â”‚       â”œâ”€â”€ backend.tf
â”‚
â””â”€â”€ shared/
    â”œâ”€â”€ locals.tf

6ï¸âƒ£ Implementation Flow (Step-by-Step)
Phase 1 â€” One-Time Setup (Static Layer)
Step 1: Create VPC module
2 private subnets
NAT Gateway
Route tables

Outputs:
vpc_id
private_subnet_ids

Step 2: Security Groups
ALB SG
Allow 80/443 from VPN CIDR only

EC2 SG
Allow 8080 from ALB SG only

No public ingress. Zero 0.0.0.0/0.

Step 3: IAM
aws-elasticbeanstalk-service-role
ec2-instance-profile role

Step 4: Private Route53 Zone

Example:
uat.internal.devopswithsiva.in
Associate with VPC.

Phase 2 â€” Ephemeral Layer (Daily 10 Hours)
Step 5: Beanstalk Application

Static logical container.

Step 6: Beanstalk Environment

Critical settings:

EnvironmentType = LoadBalanced
LoadBalancerType = application
LoadBalancerIsShared = false
ELBScheme = internal
Subnets = private subnets

In Terraform:

setting {
  namespace = "aws:ec2:vpc"
  name      = "VPCId"
}

setting {
  namespace = "aws:ec2:vpc"
  name      = "Subnets"
}

setting {
  namespace = "aws:elb:loadbalancer"
  name      = "Scheme"
  value     = "internal"
}
Step 7: Route53 Alias Record
Alias to:
data.aws_lb.beanstalk_alb.dns_name

7ï¸âƒ£ How to Auto Destroy After 10 Hours

You have 3 clean options:

Option A â€” Jenkins Scheduled Pipeline (Best for You)
Since you're already working with Jenkins + Terraform:

Pipeline:
terraform apply
Sleep 10 hours
terraform destroy

Better:
Use AWS EventBridge + Lambda instead of sleep.
Option B â€” EventBridge + Lambda Auto Destroy
Flow:
EventBridge rule (cron)
        â†“
Lambda
        â†“
terraform destroy (via SSM or container)
More production grade.


Option C â€” Scale to Zero (Better Than Destroy)

Instead of destroying:
Set ASG min=0 max=0 after 10 hours.
Keep environment alive.
No recreation delays next day.

This is usually smarter.

You're over-optimizing destruction. Compute is cheap. Re-creation cost in engineering time is not.

8ï¸âƒ£ Cost Reality Check

Internal ALB = billed hourly
NAT Gateway = billed hourly (big cost driver)

If UAT is internal only:
Do you even need NAT?
If your app doesn't pull from internet â†’ remove NAT.

That alone saves major cost.

9ï¸âƒ£ Final Recommended Design (Balanced)

âœ” Keep VPC + SG + IAM + Route53 static
âœ” Keep Beanstalk Application static
âœ” Only destroy Beanstalk Environment
âœ” Or scale ASG to zero instead of destroy

10ï¸âƒ£ Complete End-to-End Flow Summary
Developer
   â†“
Private DNS
   â†“
Internal ALB
   â†“
ASG
   â†“
EC2 (Private)
   â†“
Database (Private)

Terraform Flow:
terraform apply (static stack)
terraform apply (uat env stack)
10 hours
terraform destroy (uat env only)

11ï¸âƒ£ Hard Questions You Must Answer

Why Beanstalk instead of ECS if you already use ECS heavily?

Why destroy instead of scale-to-zero?

Why NAT if fully internal?

Is UAT traffic heavy enough to justify ALB?

If this is internal-only and light traffic, a single instance environment may be enough.



ğŸ§® Assumptions for UAT (per day)
Item	What we assume
UAT Duration	10 hours/day
Days	30 days/month (for monthly extrapolation)
EC2 Instances	2 EC2 (Beanstalk ASG min=1, avg=2)
EC2 Type	t3.micro / similar
ALB	1 internal ALB for 10 hours
NAT	1 NAT gateway (optional)
Data Transfer	Minimal (internal traffic only)
S3 / Docker pull	Assume VPC endpoints or low transfer


ğŸ’µ Pricing Components (reference pricing)
Component	Cost Basis
NAT Gateway	$0.045/hr (per gateway)
ALB (Application Load Balancer)	~$0.0225/hr base + LCU processing (low)
EC2 t3.micro	~$0.010/hr (On-Demand)
EIP Public IP	$0.005/hr (only if NAT uses Elastic IP)
Data transfer	negligible for internal traffic


ğŸ“Š Scenario A â€” With NAT
You keep a NAT gateway so your private subnets can reach public endpoints (e.g., Docker registries, package repos).

Hourly (10 hours/day)

NAT Gateway: 0.045 * 10 = $0.45

ALB (base only): 0.0225 * 10 = $0.225

EC2 Instances (2 * t3.micro): 2 * 0.010 * 10 = $0.20

EIP for NAT (optional): 0.005 * 10 = $0.05

Total / day with NAT â‰ˆ $0.925 / day

Monthly Equivalent (30 days)

â‰ˆ $27.75 / month (for just the UAT hours)

(This excludes data processing via NAT, which adds per-GB cost only if you actively reroute traffic through NAT to internet.)

ğŸ“Š Scenario B â€” Without NAT

Your private instances stay completely internal and use VPC endpoints (for S3/Docker registry) instead of NAT.

Hourly (10 hours/day)

ALB: 0.0225 * 10 = $0.225

EC2 (2 * t3.micro): 0.20

Total / day without NAT â‰ˆ $0.425 / day

Monthly Equivalent (30 days)

â‰ˆ $12.75 / month
